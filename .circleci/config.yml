%YAML 1.1
---
version: '2'
workflows:
  version: 2
  test:
    jobs:
    - test-3.8-stage:
        context: z7-stage
        filters:
          branches:
            only: /z7-stage.*/
    - test-3.8-prod:
        context: z7-prod
        filters:
          branches:
            only: /z7-prod.*/
    - test-3.9-stage:
        context: z7-stage
        filters:
          branches:
            only: /z7-stage.*/
    - test-3.9-prod:
        context: z7-prod
        filters:
          branches:
            only: /z7-prod.*/
jobs:
  test-3.8-stage:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: conf_tools,conf_tools.checks,conf_tools.code_desc,conf_tools.code_specs,conf_tools.exceptions,conf_tools.global_config,conf_tools.instantiate_utils,conf_tools.load_entries,conf_tools.master,conf_tools.objspec,conf_tools.patterns,conf_tools.special_subst,conf_tools.unittests,conf_tools.unittests.groups,conf_tools.unittests.groups.groups_test,conf_tools.unittests.instantiate_tests,conf_tools.unittests.instantiate_tests.static_test,conf_tools.unittests.pickling_test,conf_tools.unittests.templating,conf_tools.unittests.templating.other_tests,conf_tools.unittests.templating.simple_use_tests,conf_tools.unittests.utils,conf_tools.unittests.wildcards_test,conf_tools.utils,conf_tools.utils.col_logging,conf_tools.utils.expansion,conf_tools.utils.friendly_paths,conf_tools.utils.indent_string,conf_tools.utils.locate_files_imp,conf_tools.utils.not_found,conf_tools.utils.pickling,conf_tools.utils.resources,conf_tools.utils.term_color,conf_tools.utils.terminal_size,conf_tools.utils.wildcards,conf_tools.valid,conf_tools_tests
      TEST_PACKAGES: conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools_tests
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.8:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        when: always
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools_tests
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools_tests-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools_tests
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml

    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.8-prod:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: conf_tools,conf_tools.checks,conf_tools.code_desc,conf_tools.code_specs,conf_tools.exceptions,conf_tools.global_config,conf_tools.instantiate_utils,conf_tools.load_entries,conf_tools.master,conf_tools.objspec,conf_tools.patterns,conf_tools.special_subst,conf_tools.unittests,conf_tools.unittests.groups,conf_tools.unittests.groups.groups_test,conf_tools.unittests.instantiate_tests,conf_tools.unittests.instantiate_tests.static_test,conf_tools.unittests.pickling_test,conf_tools.unittests.templating,conf_tools.unittests.templating.other_tests,conf_tools.unittests.templating.simple_use_tests,conf_tools.unittests.utils,conf_tools.unittests.wildcards_test,conf_tools.utils,conf_tools.utils.col_logging,conf_tools.utils.expansion,conf_tools.utils.friendly_paths,conf_tools.utils.indent_string,conf_tools.utils.locate_files_imp,conf_tools.utils.not_found,conf_tools.utils.pickling,conf_tools.utils.resources,conf_tools.utils.term_color,conf_tools.utils.terminal_size,conf_tools.utils.wildcards,conf_tools.valid,conf_tools_tests
      TEST_PACKAGES: conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools_tests
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.8:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        when: always
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools_tests
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools_tests-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools_tests
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml

    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.9-stage:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: conf_tools,conf_tools.checks,conf_tools.code_desc,conf_tools.code_specs,conf_tools.exceptions,conf_tools.global_config,conf_tools.instantiate_utils,conf_tools.load_entries,conf_tools.master,conf_tools.objspec,conf_tools.patterns,conf_tools.special_subst,conf_tools.unittests,conf_tools.unittests.groups,conf_tools.unittests.groups.groups_test,conf_tools.unittests.instantiate_tests,conf_tools.unittests.instantiate_tests.static_test,conf_tools.unittests.pickling_test,conf_tools.unittests.templating,conf_tools.unittests.templating.other_tests,conf_tools.unittests.templating.simple_use_tests,conf_tools.unittests.utils,conf_tools.unittests.wildcards_test,conf_tools.utils,conf_tools.utils.col_logging,conf_tools.utils.expansion,conf_tools.utils.friendly_paths,conf_tools.utils.indent_string,conf_tools.utils.locate_files_imp,conf_tools.utils.not_found,conf_tools.utils.pickling,conf_tools.utils.resources,conf_tools.utils.term_color,conf_tools.utils.terminal_size,conf_tools.utils.wildcards,conf_tools.valid,conf_tools_tests
      TEST_PACKAGES: conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools_tests
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.9:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        when: always
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools_tests
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools_tests-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools_tests
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml

    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium
  test-3.9-prod:
    environment:
      COLUMNS: '160'
      # default is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PATH: /root/.local/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      COVER_PACKAGES: conf_tools,conf_tools.checks,conf_tools.code_desc,conf_tools.code_specs,conf_tools.exceptions,conf_tools.global_config,conf_tools.instantiate_utils,conf_tools.load_entries,conf_tools.master,conf_tools.objspec,conf_tools.patterns,conf_tools.special_subst,conf_tools.unittests,conf_tools.unittests.groups,conf_tools.unittests.groups.groups_test,conf_tools.unittests.instantiate_tests,conf_tools.unittests.instantiate_tests.static_test,conf_tools.unittests.pickling_test,conf_tools.unittests.templating,conf_tools.unittests.templating.other_tests,conf_tools.unittests.templating.simple_use_tests,conf_tools.unittests.utils,conf_tools.unittests.wildcards_test,conf_tools.utils,conf_tools.utils.col_logging,conf_tools.utils.expansion,conf_tools.utils.friendly_paths,conf_tools.utils.indent_string,conf_tools.utils.locate_files_imp,conf_tools.utils.not_found,conf_tools.utils.pickling,conf_tools.utils.resources,conf_tools.utils.term_color,conf_tools.utils.terminal_size,conf_tools.utils.wildcards,conf_tools.valid,conf_tools_tests
      TEST_PACKAGES: conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools conf_tools
        conf_tools conf_tools conf_tools_tests
    docker:
    - image: ${DOCKER_REGISTRY}/zupermind/zuper-ci-3.9:z7
      auth:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
    working_directory: ~/repo
    steps:
    - checkout
    - run:
        name: Build statistics
        command: |
          mkdir -p build-stats
          env | sort | tee  build-stats/env.txt
    - store_artifacts:
        path: build-stats
        destination: build-stats
    - run:
        name: Install deps
        command: |
          shyaml get-values install_requires < project.pp1.yaml > .requirements.txt
          python3 -m pip install -U pip
          python3 -m pip install  -r .requirements.txt
          rm .requirements.txt

    - run:
        name: Install testing deps
        command: |
          shyaml get-values tests_require < project.pp1.yaml > .requirements_tests.txt
          python3 -m pip  install -r .requirements_tests.txt
          rm .requirements_tests.txt

    - run:
        name: Python stats
        when: always
        command: |
          pipdeptree | tee  build-stats/pipdeptree.txt
          python3 -m pip  list   | sort | tee  build-stats/pip-list.txt
          python3 -m pip  freeze | sort | tee  build-stats/pip-freeze.txt

    - store_artifacts:
        path: build-stats
        destination: build-stats

    - run:
        name: setup.py develop
        command: |
          pip install -e . --prefix ~/.local --no-deps

    - run:
        name: Make docs
        command: |
          FILE=src/conf.py
          mkdir -p out/docs
          if test -f "$FILE"; then
              sphinx-build src out/docs
          fi

    - store_artifacts:
        path: out/docs
        destination: docs
    - run:
        background: true
        name: services
        command: |
          TARGET=services
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    - run:
        name: pre-circle-tests
        command: |
          TARGET=pre-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi
    # - run:
    #     name: Notebooks
    #     command: |
    #       make -C notebooks cleanup all


    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools
        when: always
    - run:
        name: conf_tools_tests
        command: |-
          set -euxo pipefail
          mkdir -p out/test-results
          xunit_output=$PWD/out/test-results/nose-${CIRCLE_NODE_INDEX}-conf_tools_tests-xunit.xml
          nosetests \
              --rednose --immediate \
              --cover-tests --with-coverage \
              --with-xunit --xunit-file=${xunit_output} \
              --cover-package=${COVER_PACKAGES} \
              conf_tools_tests
        when: always
    - run:
        name: post-circle-tests
        command: |
          TARGET=post-circle-tests
          if make -n $TARGET ; then
              make $TARGET
          else
              echo "Target $TARGET not defined"
          fi

    - store_test_results:
        path: out/test-results

    - run:
        name: Coverage report
        when: always
        command: |
          coverage combine || true
          coverage html -d out/coverage/${CIRCLE_NODE_INDEX}
          coverage xml

    - store_artifacts:
        path: out/coverage
        destination: coverage

    - store_artifacts:
        path: out/tests
        destination: tests

    - run:
        name: CodeCov
        when: always
        command: |
          bash <(curl -s https://codecov.io/bash)
    resource_class: medium

# sigil 214d1bb5e19941c0d764d99821bc78b1
